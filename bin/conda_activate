#!/bin/bash

SCRNAME=$0
RELNEW=$1
RELCUR=$CONDA_DEFAULT_ENV

_OFNAME=.sit_conda_env
#file_content/cds/sw/ds/ana/conda1/inst/envs/ana-4.0.36-py3
RELDIRPREFIX=/cds/sw/ds/ana/conda1/inst/envs/
RELDIR=${RELDIRPREFIX}$RELNEW

CONDA_PATH=$(conda info | grep -i 'base environment' | awk '{print $4}')
#echo "define conda env/commands> source $CONDA_PATH/etc/profile.d/conda.sh"
source $CONDA_PATH/etc/profile.d/conda.sh
#echo "XXXXXX: $_"

if [ "$0" != "-bash" ]; then # script IS NOT sourced
  echo "    ... parameter 0 is \"$0\" but expected to be \"-bash\""
  echo "to make effect this command needs to be sourced..."
  echo
  echo "usage: source conda_activate <release-name>"
  echo "       to see available run command: conda env list"
  exit 1 # if script is not sourced it is exit, othervice return
fi

if [ -z $RELNEW ]; then # release name IS EMPTY
  echo "release name must be specified, to see available run command: conda env list"
  echo "usage: source conda_activate <release-name>"
  return 2 ## exit 0 # exits session if script is sorced
fi

LISTOFRELS=$(conda env list | grep -i $RELNEW | awk '{print $1}')

echo "current release  $RELCUR"
echo "activate release $RELNEW"


is_available=false

if [ -z "$LISTOFRELS" ]; then
  echo "list of found releases is empty"
else
  for rel in $LISTOFRELS; do
    echo "found release $rel"
    if [ $rel == $RELNEW ]; then
      #echo " then requested release is available"
      is_available=true
      break
    fi
  done
fi

if [ $is_available = true ]; then # release is found in conda env list
  echo "  requested release is available in conda env list"
else
  echo "========="
  conda env list
  echo "========="
  echo "requested release $RELNEW IS NOT FOUND in the list above generated by command: conda env list"
  echo "please select one of available releases"
  echo "usage: source conda_activate <release-name>"
  return 3
fi

echo "> conda deactivate"
conda deactivate

echo "> conda activate $RELNEW"
conda activate $RELNEW
export SIT_DATA=/cds/sw/ds/ana/conda1/inst/envs/$RELNEW/data:/cds/group/psdm/data/

if [ -f ${_OFNAME} ]; then
  echo "file ${_OFNAME} new content: ${RELDIR}"
  echo $RELDIR > ${_OFNAME} # replace content
else
  echo "File ${_OFNAME} IS NOT AVAILABLE"
fi

# EOF
